{% extends "base.html" %}
{% block content %}
<h1>Estoque</h1>

<p class="text-muted">
  Médias calculadas com base nos últimos {{ janela_dias }} dias de vendas.
  Estoque mínimo desejado: {{ dias_minimos }} dias de cobertura.
</p>

<h2>Visão de Estoque e Giro</h2>
<table>
  <thead>
    <tr>
      <th>Produto</th>
      <th>SKU</th>
      <th>Estoque atual</th>
      <th>Média diária<br>(últ. {{ janela_dias }} dias)</th>
      <th>Média mensal<br>(estimada)</th>
      <th>Dias de cobertura</th>
      <th>Situação</th>
    </tr>
  </thead>
  <tbody>
    {% for p in produtos %}
    <tr class="{% if p.precisa_repor %}estoque-alerta{% endif %}">
      <td>{{ p.nome }}</td>
      <td>{{ p.sku }}</td>
      <td>{{ p.estoque_atual|int }}</td>
      <td>{{ '%.2f'|format(p.media_diaria) }}</td>
      <td>{{ '%.2f'|format(p.media_mensal) }}</td>
      <td>
        {% if p.dias_cobertura is none %}
          —
        {% else %}
          {{ '%.1f'|format(p.dias_cobertura) }} dias
        {% endif %}
      </td>
      <td>
        {% if p.dias_cobertura is none %}
          <span class="badge badge-neutral">Sem vendas recentes</span>
        {% elif p.precisa_repor %}
          <span class="badge badge-danger">Repor estoque</span>
        {% else %}
          <span class="badge badge-ok">OK</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<br>

<h2>Ajustar estoque</h2>
<form method="POST" action="{{ url_for('ajuste_estoque') }}">
  <div class="form-group">
    <label for="produto_id">Produto</label>
    <select name="produto_id" id="produto_id">
      {% for p in produtos %}
      <option value="{{ p.id }}">{{ p.nome }} ({{ p.sku }})</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label for="tipo">Tipo de ajuste</label>
    <select name="tipo" id="tipo">
      <option value="entrada">Entrada</option>
      <option value="saida">Saída</option>
    </select>
  </div>

  <div class="form-group">
    <label for="quantidade">Quantidade</label>
    <input type="number" name="quantidade" id="quantidade" min="1" step="1" required>
  </div>

  <div class="form-group">
    <label for="custo_unitario">Custo unitário (opcional)</label>
    <input type="number" step="0.01" name="custo_unitario" id="custo_unitario">
    <p class="small">Se informado em uma entrada, atualiza o custo do produto.</p>
  </div>

  <div class="form-group">
    <label for="observacao">Observação</label>
    <textarea name="observacao" id="observacao" rows="2"></textarea>
  </div>

  <button type="submit" class="btn btn-primary">Salvar ajuste</button>
</form>
{% endblock %}
