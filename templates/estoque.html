{% extends "base.html" %}
{% block content %}

<div class="container mx-auto px-4 py-6">

    <!-- TÍTULO -->
    <h1 class="text-3xl font-bold mb-6">Estoque e Reposição</h1>

    <!-- CARDS RESUMO -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

        <!-- Total unidades -->
        <div class="stat bg-white rounded shadow p-4">
            <div class="stat-title">Total de Unidades em Estoque</div>
            <div class="stat-value">{{ total_unidades_estoque|int }}</div>
        </div>

        <!-- Custo total -->
        <div class="stat bg-white rounded shadow p-4">
            <div class="stat-title">Custo Total do Estoque</div>
            <div class="stat-value">R$ {{ '%.2f'|format(total_custo_estoque or 0) }}</div>
        </div>

        <!-- LUCRO POTENCIAL DO ESTOQUE -->
        <div class="stat bg-green-50 border border-green-300 rounded p-4">
            <div class="stat-title font-bold text-green-700">
                Receita Potencial do Estoque (Lucro Líquido Esperado)
            </div>
            <div class="stat-value text-green-700">
                R$ {{ '%.2f'|format(lucro_potencial_total or 0) }}
            </div>
            <div class="stat-desc text-sm text-green-600 mt-2">
                Baseado no desempenho histórico real de vendas.
            </div>
        </div>

    </div>

    <!-- PARÂMETROS DE ANÁLISE / EXPLICAÇÃO (OPCIONAL) -->
    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div class="bg-white rounded shadow p-4">
            <h2 class="font-semibold mb-2">Parâmetros de análise</h2>
            <p>Período de média: últimos {{ janela_dias }} dias.</p>
            <p>Estoque mínimo desejado: {{ dias_minimos }} dias de cobertura.</p>
            <p>Produtos com cobertura abaixo do mínimo aparecem como <strong>"Repor"</strong>.</p>
        </div>
        <div class="bg-white rounded shadow p-4">
            <h2 class="font-semibold mb-2">Como o lucro potencial é calculado?</h2>
            <p>Para cada produto, o sistema usa o histórico de vendas para calcular o lucro líquido por unidade:</p>
            <p class="mt-1">
                <strong>Lucro líquido = Receita - Comissão ML - Custo - Imposto - Despesas</strong>
            </p>
            <p class="mt-1">
                Esse lucro por unidade é multiplicado pelo estoque atual, gerando o
                <strong>lucro potencial do estoque</strong>.
            </p>
        </div>
    </div>

    <!-- TABELA DE PRODUTOS -->
    <div class="overflow-x-auto">
        <table class="table table-zebra w-full text-sm">

            <thead>
                <tr class="bg-gray-200">
                    <th>Produto</th>
                    <th>SKU</th>
                    <th>Estoque atual</th>
                    <th>Custo unitário (R$)</th>
                    <th>Custo total (R$)</th>

                    <th>Média diária</th>
                    <th>Média mensal</th>
                    <th>Dias de cobertura</th>

                    <th>Lucro potencial (R$)</th>
                    <th>Retorno (%)</th>

                    <th>Situação</th>
                </tr>
            </thead>

            <tbody>
                {% for p in produtos %}
                <tr>
                    <td>{{ p.nome }}</td>
                    <td>{{ p.sku }}</td>
                    <td>{{ p.estoque_atual|int }}</td>

                    <td>R$ {{ '%.2f'|format(p.custo_unitario or 0) }}</td>
                    <td>R$ {{ '%.2f'|format(p.custo_estoque or 0) }}</td>

                    <!-- 2 casas decimais nas médias -->
                    <td>{{ '%.2f'|format(p.media_diaria or 0) }}</td>
                    <td>{{ '%.2f'|format(p.media_mensal or 0) }}</td>

                    <!-- Dias de cobertura também com 2 casas -->
                    <td>
                        {% if p.dias_cobertura %}
                            {{ '%.2f'|format(p.dias_cobertura) }} dias
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    <!-- LUCRO POTENCIAL -->
                    <td class="font-semibold text-green-700">
                        R$ {{ '%.2f'|format(p.lucro_potencial or 0) }}
                    </td>

                    <!-- RETORNO % -->
                    <td class="font-semibold text-blue-700">
                        {{ '%.2f'|format(p.retorno_percent or 0) }}%
                    </td>

                    <!-- SITUAÇÃO REPOR / OK -->
                    <td>
                        {% if p.precisa_repor %}
                            <span class="badge badge-warning">Repor</span>
                        {% else %}
                            <span class="badge badge-success">OK</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

</div>

{% endblock %}
