{% extends "base.html" %}
{% block content %}

<div class="container mx-auto px-4 py-6">

    <!-- TÍTULO -->
    <h1 class="text-3xl font-bold mb-6 text-white">Estoque e Reposição</h1>

    <!-- CARDS RESUMO -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

        <!-- Total unidades -->
        <div class="rounded-lg shadow p-4 bg-white text-slate-900">
            <div class="text-sm font-semibold">Total de Unidades em Estoque</div>
            <div class="text-3xl font-bold mt-2">{{ total_unidades_estoque|int }}</div>
        </div>

        <!-- Custo total -->
        <div class="rounded-lg shadow p-4 bg-white text-slate-900">
            <div class="text-sm font-semibold">Custo Total do Estoque</div>
            <div class="text-3xl font-bold mt-2">
                R$ {{ '%.2f'|format(total_custo_estoque or 0) }}
            </div>
        </div>

        <!-- LUCRO POTENCIAL DO ESTOQUE -->
        <div class="rounded-lg shadow p-4" style="background: #0b1733;">
            <div class="text-sm font-bold text-green-300">
                Receita Potencial do Estoque (Lucro Líquido Esperado)
            </div>
            <div class="text-3xl font-bold mt-2 text-green-400">
                R$ {{ '%.2f'|format(lucro_potencial_total or 0) }}
            </div>
            <div class="text-xs mt-2 text-green-100">
                Baseado no desempenho histórico real de vendas.
            </div>
        </div>

    </div>

    <!-- PARÂMETROS / EXPLICAÇÃO -->
    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">

        <!-- Parâmetros -->
        <div class="rounded-lg shadow p-4 bg-white text-slate-900">
            <h2 class="font-semibold mb-2 text-slate-900">Parâmetros de análise</h2>
            <p>Período de média: últimos {{ janela_dias }} dias.</p>
            <p>Estoque mínimo desejado: {{ dias_minimos }} dias de cobertura.</p>
            <p>Produtos com cobertura abaixo do mínimo aparecem como
                <strong>"Repor"</strong>.
            </p>
        </div>

        <!-- Como é calculado -->
        <div class="rounded-lg shadow p-4 bg-white text-slate-900">
            <h2 class="font-semibold mb-2 text-slate-900">Como o lucro potencial é calculado?</h2>
            <p>
                Para cada produto, o sistema usa o histórico de vendas para calcular
                o lucro líquido por unidade:
            </p>
            <p class="mt-1 font-semibold">
                Lucro líquido = Receita - Comissão ML - Custo - Imposto - Despesas
            </p>
            <p class="mt-1">
                Esse lucro por unidade é multiplicado pelo estoque atual,
                gerando o <strong>lucro potencial do estoque</strong>.
            </p>
        </div>

    </div>

    <!-- TABELA DE PRODUTOS -->
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm bg-white text-slate-900 border border-slate-200">
            <thead class="bg-slate-100">
                <tr>
                    <th class="px-3 py-2 text-left">Produto</th>
                    <th class="px-3 py-2 text-left">SKU</th>
                    <th class="px-3 py-2 text-right">Estoque atual</th>
                    <th class="px-3 py-2 text-right">Custo unitário (R$)</th>
                    <th class="px-3 py-2 text-right">Custo total (R$)</th>

                    <th class="px-3 py-2 text-right">Média diária</th>
                    <th class="px-3 py-2 text-right">Média mensal</th>
                    <th class="px-3 py-2 text-right">Dias de cobertura</th>

                    <th class="px-3 py-2 text-right">Lucro potencial (R$)</th>
                    <th class="px-3 py-2 text-right">Retorno (%)</th>

                    <th class="px-3 py-2 text-center">Situação</th>
                </tr>
            </thead>
            <tbody>
                {% for p in produtos %}
                <tr class="border-t border-slate-200">
                    <td class="px-3 py-2">{{ p.nome }}</td>
                    <td class="px-3 py-2">{{ p.sku }}</td>
                    <td class="px-3 py-2 text-right">{{ p.estoque_atual|int }}</td>

                    <td class="px-3 py-2 text-right">
                        R$ {{ '%.2f'|format(p.custo_unitario or 0) }}
                    </td>
                    <td class="px-3 py-2 text-right">
                        R$ {{ '%.2f'|format(p.custo_estoque or 0) }}
                    </td>

                    <!-- 2 casas nas médias -->
                    <td class="px-3 py-2 text-right">
                        {{ '%.2f'|format(p.media_diaria or 0) }}
                    </td>
                    <td class="px-3 py-2 text-right">
                        {{ '%.2f'|format(p.media_mensal or 0) }}
                    </td>

                    <!-- 2 casas nos dias de cobertura -->
                    <td class="px-3 py-2 text-right">
                        {% if p.dias_cobertura %}
                            {{ '%.2f'|format(p.dias_cobertura) }} dias
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    <!-- Lucro potencial -->
                    <td class="px-3 py-2 text-right font-semibold text-emerald-600">
                        R$ {{ '%.2f'|format(p.lucro_potencial or 0) }}
                    </td>

                    <!-- Retorno -->
                    <td class="px-3 py-2 text-right font-semibold text-blue-700">
                        {{ '%.2f'|format(p.retorno_percent or 0) }}%
                    </td>

                    <!-- Situação -->
                    <td class="px-3 py-2 text-center">
                        {% if p.precisa_repor %}
                            <span class="px-2 py-1 rounded-full text-xs font-semibold"
                                  style="background:#fef3c7; color:#92400e;">
                                Repor
                            </span>
                        {% else %}
                            <span class="px-2 py-1 rounded-full text-xs font-semibold"
                                  style="background:#dcfce7; color:#166534;">
                                OK
                            </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

{% endblock %}
