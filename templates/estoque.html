{% extends "base.html" %}

{% block title %}Estoque & Reposição • Redutron ERP{% endblock %}

{% block page_icon %}
  <i class="bi bi-stack text-primary"></i>
{% endblock %}

{% block page_title %}
  Estoque & Reposição
{% endblock %}

{% block content %}

<!-- Topo: título + botões -->
<div class="card-glass mb-3">
  <div class="card-glass-header">
    <div>
      <div class="card-glass-title">
        <i class="bi bi-box-seam"></i>
        Visão geral do estoque
      </div>
      <div class="stat-sub">
        Monitoramento em tempo real do seu estoque de produtos
      </div>
    </div>
    <div class="d-flex gap-2">
      <!-- Botão de sugestão de compra (base, lógica você pluga depois) -->
      <button type="button" class="btn btn-outline-light btn-sm">
        <i class="bi bi-lightbulb"></i> Sugestão de compra do mês
      </button>

      <!-- Botão Ajustar Estoque (abre o modal) -->
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAjusteEstoque">
        <i class="bi bi-pencil-square me-1"></i> Ajustar Estoque
      </button>
    </div>
  </div>

  <!-- Cards de totais -->
  <div class="row g-3">
    <div class="col-md-4">
      <div>
        <div class="stat-label">Total de unidades em estoque</div>
        <div class="stat-value">
          {{ total_unidades or 0 }}
        </div>
        <div class="stat-sub">Soma de todas as unidades cadastradas</div>
      </div>
    </div>

    <div class="col-md-4">
      <div>
        <div class="stat-label">Custo total do estoque</div>
        <div class="stat-value">
          R$ {{ "%.2f"|format(custo_total_estoque or 0) }}
        </div>
        <div class="stat-sub">Baseado no custo unitário de cada produto</div>
      </div>
    </div>

    <div class="col-md-4">
      <div>
        <div class="stat-label">Lucro potencial do estoque</div>
        <div class="stat-value">
          R$ {{ "%.2f"|format(lucro_potencial_estoque or 0) }}
        </div>
        <div class="stat-sub">Você pode plugar o cálculo com as vendas do ML</div>
      </div>
    </div>
  </div>
</div>

<!-- Tabela de itens de estoque -->
<div class="card-glass">
  <div class="card-glass-header">
    <div class="card-glass-title">
      <i class="bi bi-list-ul"></i>
      Itens de estoque
    </div>
    <span class="badge-soft">
      {{ itens_estoque|length if itens_estoque is defined else (produtos|length if produtos is defined else 0) }} produtos
    </span>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Produto</th>
          <th class="text-end">Estoque</th>
          <th class="text-end">Custo unit.</th>
          <th class="text-end">Custo em estoque</th>
          <th class="text-end">Média/dia (30d)</th>
          <th class="text-end">Cobertura (dias)</th>
          <th class="text-center">Status</th>
        </tr>
      </thead>
      <tbody>
        {% if itens_estoque is defined and itens_estoque %}
          {# Versão usando a lista calculada na rota #}
          {% for item in itens_estoque %}
            <tr>
              <td class="text-soft">
                {{ item.sku or '—' }}
              </td>
              <td>{{ item.nome }}</td>
              <td class="text-end">{{ item.estoque }}</td>
              <td class="text-end">
                R$ {{ "%.2f"|format(item.custo_unitario or 0) }}
              </td>
              <td class="text-end">
                R$ {{ "%.2f"|format(item.custo_estoque or 0) }}
              </td>
              <td class="text-end">
                {{ item.media_diaria or 0 }}
              </td>
              <td class="text-end">
                {% if item.cobertura_dias %}
                  {{ item.cobertura_dias }} d
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="text-center">
                <span class="badge badge-chip bg-{{ item.status_badge or 'success' }}">
                  {{ item.status or 'OK' }}
                </span>
              </td>
            </tr>
          {% endfor %}
        {% elif produtos is defined and produtos %}
          {# Fallback simples: usa diretamente o resultado da tabela produtos #}
          {% for p in produtos %}
            <tr>
              <td class="text-soft">
                {{ p.sku if p.sku is defined else '—' }}
              </td>
              <td>{{ p.nome }}</td>
              <td class="text-end">
                {{ p.estoque_atual if p.estoque_atual is defined else (p.estoque or 0) }}
              </td>
              <td class="text-end">
                R$ {{ "%.2f"|format(p.custo_unitario if p.custo_unitario is defined else 0) }}
              </td>
              <td class="text-end">
                {% set est = p.estoque_atual if p.estoque_atual is defined else (p.estoque or 0) %}
                {% set custo = p.custo_unitario if p.custo_unitario is defined else 0 %}
                R$ {{ "%.2f"|format((est or 0) * (custo or 0)) }}
              </td>
              <td class="text-end">0</td>
              <td class="text-end">—</td>
              <td class="text-center">
                <span class="badge badge-chip bg-success">
                  OK
                </span>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center text-soft py-3">
              Nenhum produto cadastrado no estoque ainda.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de Ajuste de Estoque -->
<div class="modal fade" id="modalAjusteEstoque" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background:#0f172a; border:1px solid rgba(148,163,184,.35); color:#e5e7eb;">
      
      <div class="modal-header" style="border-bottom:1px solid rgba(148,163,184,.25);">
        <h5 class="modal-title">
          <i class="bi bi-stack"></i> Ajustar Estoque
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- OBS: usa a SUA função ajuste_estoque (POST /estoque/ajuste) -->
      <form method="POST" action="{{ url_for('ajuste_estoque') }}">
        <div class="modal-body">

          <!-- Tipo de movimentação (entrada ou saída) -->
          <label class="form-label">Tipo de movimentação</label>
          <select class="form-select" name="tipo" required>
            <option value="entrada">Entrada (aumenta estoque)</option>
            <option value="saida">Saída / Ajuste negativo</option>
          </select>

          <!-- Produto -->
          <label class="form-label mt-3">Produto</label>
          <select class="form-select" name="produto_id" required>
            {% for p in produtos %}
              <option value="{{ p.id }}">
                {{ p.nome }} — Estoque atual:
                {{ p.estoque_atual if p.estoque_atual is defined else (p.estoque or 0) }}
              </option>
            {% endfor %}
          </select>

          <!-- Quantidade -->
          <label class="form-label mt-3">Quantidade</label>
          <input
            type="number"
            class="form-control"
            name="quantidade"
            required
            min="1"
          >

          <!-- Custo unitário (opcional, usado para recalcular custo médio na ENTRADA) -->
          <label class="form-label mt-3">
            Custo unitário (R$)
            <span class="text-soft">(opcional, usado em entradas para recalcular custo médio)</span>
          </label>
          <input
            type="number"
            step="0.01"
            class="form-control"
            name="custo_unitario"
            placeholder="Ex: 25.90"
          >

          <!-- Observação -->
          <label class="form-label mt-3">Observação (opcional)</label>
          <textarea class="form-control" name="observacao" rows="2"></textarea>

        </div>

        <div class="modal-footer" style="border-top:1px solid rgba(148,163,184,.25);">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check2-circle"></i> Confirmar ajuste
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

{% endblock %}
