{% extends "base.html" %}
{% block title %}Vendas - Metrify{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <h1 class="h3 mb-4">Vendas</h1>

    <!-- FILTROS -->
    <form class="row g-3 mb-4" method="GET">
        <div class="col-md-3">
            <label class="form-label">Data início</label>
            <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Data fim</label>
            <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100">Filtrar</button>
        </div>
    </form>

    <!-- GRÁFICOS -->
    <div class="row g-4">

        <!-- FATURAMENTO DIÁRIO -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header"><strong>Faturamento diário</strong></div>
                <div class="card-body"><canvas id="grafFaturamento"></canvas></div>
            </div>
        </div>

        <!-- QUANTIDADE DIÁRIA -->
        <div class="col-xl-6 col-12">
            <div class="card shadow-sm">
                <div class="card-header"><strong>Quantidade vendida por dia</strong></div>
                <div class="card-body"><canvas id="grafQuantidade"></canvas></div>
            </div>
        </div>

        <!-- LUCRO DIÁRIO -->
        <div class="col-xl-6 col-12">
            <div class="card shadow-sm">
                <div class="card-header"><strong>Lucro diário</strong></div>
                <div class="card-body"><canvas id="grafLucro"></canvas></div>
            </div>
        </div>

        <!-- COMPARAÇÃO MÊS ATUAL X ANTERIOR -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header"><strong>Comparativo: Mês atual x Mês anterior</strong></div>
                <div class="card-body"><canvas id="grafComparativo"></canvas></div>
            </div>
        </div>

    </div>

    <!-- TABELA DE VENDAS -->
    <div class="card shadow-sm border-0 mt-4">
        <div class="card-header bg-transparent">
            <h5 class="mb-0">Lista de vendas</h5>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Produto</th>
                        <th class="text-end">Qtd</th>
                        <th class="text-end">Preço</th>
                        <th class="text-end">Receita</th>
                        <th class="text-end">Custo</th>
                        <th class="text-end">Margem</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vendas %}
                    <tr>
                        <td>{{ v.data_venda }}</td>
                        <td>{{ v.nome }}</td>
                        <td class="text-end">{{ v.quantidade }}</td>
                        <td class="text-end">R$ {{ '%.2f'|format(v.preco_venda_unitario) }}</td>
                        <td class="text-end">R$ {{ '%.2f'|format(v.receita_total) }}</td>
                        <td class="text-end">R$ {{ '%.2f'|format(v.custo_total) }}</td>
                        <td class="text-end">R$ {{ '%.2f'|format(v.margem_contribuicao) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const labels = {{ grafico_labels|tojson }};
const faturamento = {{ grafico_faturamento|tojson }};
const quantidade = {{ grafico_quantidade|tojson }};
const lucro = {{ grafico_lucro|tojson }};
const cmp_labels = {{ grafico_cmp_labels|tojson }};
const cmp_atual = {{ grafico_cmp_atual|tojson }};
const cmp_anterior = {{ grafico_cmp_anterior|tojson }};

// FATURAMENTO
new Chart(document.getElementById('grafFaturamento'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: "Faturamento (R$)",
            data: faturamento,
            borderWidth: 3,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0,123,255,0.2)',
            fill: true,
            tension: 0.3
        }]
    }
});

// QUANTIDADE
new Chart(document.getElementById('grafQuantidade'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: "Quantidade vendida",
            data: quantidade,
            backgroundColor: '#0d6efd'
        }]
    }
});

// LUCRO
new Chart(document.getElementById('grafLucro'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: "Lucro (R$)",
            data: lucro,
            borderWidth: 3,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40,167,69,0.2)',
            fill: true,
            tension: 0.3
        }]
    }
});

// COMPARATIVO MÊS A MÊS
new Chart(document.getElementById('grafComparativo'), {
    type: 'line',
    data: {
        labels: cmp_labels,
        datasets: [
            {
                label: "Mês atual",
                data: cmp_atual,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13,110,253,0.2)',
                tension: 0.3,
                fill: true
            },
            {
                label: "Mês anterior",
                data: cmp_anterior,
                borderColor: '#6c757d',
                backgroundColor: 'rgba(108,117,125,0.2)',
                tension: 0.3,
                fill: true
            }
        ]
    }
});
</script>

{% endblock %}
