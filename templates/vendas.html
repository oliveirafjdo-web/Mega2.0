{% extends "base.html" %}
{% block content %}
<h1>Vendas</h1>

<div class="filter-card">
  <div class="filter-card-header">Filtro por data</div>

  <form method="get">
    <div class="filter-row">

      <div class="filter-field">
        <label>Data início</label>
        <input type="date" name="data_inicio" value="{{ data_inicio }}">
      </div>

      <div class="filter-field">
        <label>Data fim</label>
        <input type="date" name="data_fim" value="{{ data_fim }}">
      </div>

      <div class="filter-actions">
        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a href="{{ url_for('lista_vendas') }}" class="btn btn-link">Limpar</a>
      </div>

    </div>
  </form>
</div>

<h3>Registrar venda manual</h3>
<form method="POST" action="{{ url_for('criar_venda_manual') }}" class="filters">
  <div>
    <label>Produto</label>
    <select name="produto_id" required>
      {% for p in produtos %}
        <option value="{{ p.id }}">{{ p.nome }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Quantidade</label>
    <input type="number" name="quantidade" min="1" required>
  </div>
  <div>
    <label>Preço unitário (R$)</label>
    <input type="number" step="0.01" name="preco_venda_unitario" required>
  </div>
  <div>
    <label>Data da venda</label>
    <input type="datetime-local" name="data_venda">
  </div>
  <div>
    <button type="submit" class="btn btn-success">Lançar venda</button>
  </div>
</form>

<h2>Lista de vendas</h2>
<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Produto</th>
      <th>Origem</th>
      <th>Qtd</th>
      <th>Preço unitário</th>
      <th>Receita</th>
      <th>Custo</th>
      <th>Margem</th>
      <th>Comissão (est.)</th>
      <th>Ações</th>
    </tr>
  </thead>

  <tbody>
    {% for v in vendas %}
      <tr>
        <td>{{ v.data_venda }}</td>
        <td>{{ v.nome }}</td>
        <td>{{ v.origem }}</td>
        <td>{{ v.quantidade }}</td>
        <td>R$ {{ '%.2f'|format(v.preco_venda_unitario or 0) }}</td>
        <td>R$ {{ '%.2f'|format(v.receita_total or 0) }}</td>
        <td>R$ {{ '%.2f'|format(v.custo_total or 0) }}</td>
        <td>R$ {{ '%.2f'|format(v.margem_contribuicao or 0) }}</td>
        <td>
          {# mesma fórmula da rota, só pra exibição #}
          {% set receita = v.receita_total or 0 %}
          {% set custo = v.custo_total or 0 %}
          {% set margem = v.margem_contribuicao or 0 %}
          {% set comissao_est = (receita - custo) - margem %}
          R$ {{ '%.2f'|format(comissao_est if comissao_est > 0 else 0) }}
        </td>
        <td>... ações ...</td>
      </tr>
    {% endfor %}
  </tbody>

  <tfoot>
  <tr>
    <!-- Primeiras 3 colunas -->
    <th colspan="3" style="text-align:right;">Totais:</th>

    <!-- Qtd total -->
    <th>{{ totais.qtd|int }}</th>

    <!-- Coluna vazia (preço unitário) -->
    <th></th>

    <!-- Receita -->
    <th>R$ {{ "%.2f"|format(totais.receita) }}</th>

    <!-- Custo -->
    <th>R$ {{ "%.2f"|format(totais.custo) }}</th>

    <!-- Margem -->
    <th>R$ {{ "%.2f"|format(totais.margem) }}</th>

    <!-- Comissão -->
    <th>R$ {{ "%.2f"|format(totais.comissao) }}</th>

    <!-- ESSENCIAL: coluna de AÇÕES -->
    <th></th>  
  </tr>
</tfoot>

<h2>Lotes de importação</h2>
<table>
  <thead>
    <tr>
      <th>Lote</th>
      <th>Qtd. vendas</th>
      <th>Receita do lote</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    {% for l in lotes %}
    <tr>
      <td>{{ l.lote_importacao }}</td>
      <td>{{ l.qtd_vendas }}</td>
      <td>R$ {{ '%.2f'|format(l.receita_lote) }}</td>
      <td>
        <form method="POST" action="{{ url_for('excluir_lote_vendas', lote_id=l.lote_importacao) }}" style="display:inline;">
          <button type="submit" class="btn btn-danger" onclick="return confirm('Excluir todas as vendas deste lote?');">Excluir lote</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
