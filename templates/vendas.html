{% extends "base.html" %}

{% block title %}Vendas • MetriFy{% endblock %}
{% block page_icon %}<i class="bi bi-receipt-cutoff text-primary"></i>{% endblock %}
{% block page_title %}Vendas & Lotes{% endblock %}

{% block content %}

<div class="card-glass mb-3">
  <div class="card-glass-header">
    <div class="card-glass-title">
      <i class="bi bi-funnel"></i> Filtro por período
    </div>
  </div>

  <form class="row g-2 align-items-end" method="get" action="{{ url_for('lista_vendas') }}">
    <div class="col-12 col-md-3">
      <label class="form-label" for="data_inicio">Data inicial</label>
      <input
        type="date"
        id="data_inicio"
        name="data_inicio"
        class="form-control"
        value="{{ data_inicio }}"
      >
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label" for="data_fim">Data final</label>
      <input
        type="date"
        id="data_fim"
        name="data_fim"
        class="form-control"
        value="{{ data_fim }}"
      >
    </div>
    <div class="col-12 col-md-6 d-flex gap-2 mt-2 mt-md-0">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-search"></i> Aplicar filtro
      </button>
      <a href="{{ url_for('lista_vendas') }}" class="btn btn-outline-light">
        <i class="bi bi-x-circle"></i> Limpar
      </a>
    </div>
  </form>
</div>

<!-- Cards de totais -->
<div class="row g-3 mb-3">
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card-glass">
      <div class="card-glass-title"><i class="bi bi-hash"></i> Total de Itens</div>
      <div class="stat-value">{{ '%.0f'|format(totais.qtd) }}</div>
      <div class="stat-sub">Quantidade total vendida</div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card-glass">
      <div class="card-glass-title"><i class="bi bi-cash-coin text-success"></i> Receita</div>
      <div class="stat-value">R$ {{ '%.2f'|format(totais.receita) }}</div>
      <div class="stat-sub">Soma da coluna receita_total</div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card-glass">
      <div class="card-glass-title"><i class="bi bi-box-seam text-secondary"></i> Custo</div>
      <div class="stat-value">R$ {{ '%.2f'|format(totais.custo) }}</div>
      <div class="stat-sub">Soma da coluna custo_total</div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card-glass">
      <div class="card-glass-title"><i class="bi bi-graph-up-arrow text-info"></i> Margem de contribuição</div>
      <div class="stat-value">R$ {{ '%.2f'|format(totais.margem) }}</div>
      <div class="stat-sub">Margem = receita - custo - comissão</div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-lg-3">
    <div class="card-glass h-100">
      <div class="card-glass-header">
        <div class="card-glass-title">
          <i class="bi bi-plus-circle"></i> Registrar venda manual
        </div>
      </div>
      <form method="post" action="{{ url_for('criar_venda_manual') }}">
        <div class="mb-2">
          <label class="form-label" for="produto_id">Produto</label>
          <select class="form-select" id="produto_id" name="produto_id" required>
            <option value="">Selecione...</option>
            {% for p in produtos %}
              <option value="{{ p.id }}">{{ p.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label" for="quantidade">Quantidade</label>
          <input type="number" min="1" class="form-control" id="quantidade" name="quantidade" required>
        </div>
        <div class="mb-2">
          <label class="form-label" for="preco_venda_unitario">Preço unitário (R$)</label>
          <input type="number" step="0.01" class="form-control" id="preco_venda_unitario" name="preco_venda_unitario" required>
        </div>
        <div class="mb-3">
          <label class="form-label" for="data_venda">Data da venda</label>
          <input type="datetime-local" class="form-control" id="data_venda" name="data_venda">
          <div class="text-soft mt-1">Se vazio, usa a data e hora atual.</div>
        </div>
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-save"></i> Salvar venda
        </button>
      </form>
    </div>
  </div>

  <div class="col-12 col-lg-9">
    <div class="card-glass mb-3">
      <div class="card-glass-header">
        <div class="card-glass-title">
          <i class="bi bi-layers"></i> Lotes de importação Mercado Livre
        </div>
      </div>
      {% if lotes %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Lote</th>
                <th class="text-end">Qtd. vendas</th>
                <th class="text-end">Receita lote (R$)</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for lote in lotes %}
                <tr>
                  <td>{{ lote.lote_importacao }}</td>
                  <td class="text-end">{{ lote.qtd_vendas }}</td>
                  <td class="text-end">R$ {{ '%.2f'|format(lote.receita_lote) }}</td>
                  <td class="text-end">
                    <form method="post" action="{{ url_for('excluir_lote_vendas', lote_id=lote.lote_importacao) }}" class="d-inline" onsubmit="return confirm('Excluir todas as vendas deste lote?');">
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i> Excluir lote
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-soft">Ainda não há vendas importadas por lote.</div>
      {% endif %}
    </div>

    <div class="card-glass">
      <div class="card-glass-header">
        <div class="card-glass-title">
          <i class="bi bi-table"></i> Lista de vendas
        </div>
        <span class="badge-soft">{{ vendas|length }} registros</span>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Data</th>
              <th>Produto</th>
              <th class="text-end">Qtd.</th>
              <th class="text-end">Preço unit. (R$)</th>
              <th class="text-end">Receita (R$)</th>
              <th class="text-end">Custo (R$)</th>
              <th class="text-end">Margem contrib. (R$)</th>
              <th>Origem</th>
              <th>Lote</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% if vendas %}
              {% for v in vendas %}
                <tr>
                  <td>{{ v.id }}</td>
                  <td>
                    {% if v.data_venda %}
                      <span class="text-soft">{{ v.data_venda }}</span>
                    {% else %}
                      <span class="text-soft">-</span>
                    {% endif %}
                  </td>
                  <td>{{ v.nome }}</td>
                  <td class="text-end">{{ v.quantidade }}</td>
                  <td class="text-end">R$ {{ '%.2f'|format(v.preco_venda_unitario) }}</td>
                  <td class="text-end">R$ {{ '%.2f'|format(v.receita_total) }}</td>
                  <td class="text-end">R$ {{ '%.2f'|format(v.custo_total) }}</td>
                  <td class="text-end">R$ {{ '%.2f'|format(v.margem_contribuicao) }}</td>
                  <td>
                    <span class="badge bg-secondary badge-chip">{{ v.origem }}</span>
                  </td>
                  <td>
                    {% if v.lote_importacao %}
                      <span class="badge bg-dark badge-chip">{{ v.lote_importacao }}</span>
                    {% else %}
                      <span class="text-soft">-</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <a href="{{ url_for('editar_venda', venda_id=v.id) }}" class="btn btn-sm btn-outline-light">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <form method="post" action="{{ url_for('excluir_venda', venda_id=v.id) }}" class="d-inline" onsubmit="return confirm('Confirmar exclusão desta venda?');">
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="11" class="text-center text-soft py-3">
                  Nenhuma venda encontrada para o período selecionado.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}
