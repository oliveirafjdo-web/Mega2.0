{% extends "base.html" %}
{% block title %}Relatório de lucro · MetriFy{% endblock %}
{% block header_title %}Relatório de lucro por produto{% endblock %}

{% block content %}
<div class="card-soft mb-3">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <div class="metric-label">Margem líquida</div>
      <div class="metric-sub">
        Lucro líquido = Receita - Comissão ML - Custo - Imposto - Despesas gerais.
      </div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <span class="badge-soft">Imposto: {{ '%.2f'|format(imposto_percent) }}%</span>
      <span class="badge-soft">Despesas: {{ '%.2f'|format(despesas_percent) }}%</span>
    </div>
  </div>
</div>

<div class="card-soft mb-3">
  <div class="row g-2">
    <div class="col-6 col-md-2">
      <div class="metric-sub">Qtd. total</div>
      <div class="metric-value" style="font-size:16px;">{{ '%.0f'|format(totais.qtd) }}</div>
    </div>
    <div class="col-6 col-md-2">
      <div class="metric-sub">Receita total</div>
      <div class="metric-value" style="font-size:16px;">R$ {{ '%.2f'|format(totais.receita) }}</div>
    </div>
    <div class="col-6 col-md-2">
      <div class="metric-sub">Custo total</div>
      <div class="metric-value" style="font-size:16px;">R$ {{ '%.2f'|format(totais.custo) }}</div>
    </div>
    <div class="col-6 col-md-2">
      <div class="metric-sub">Comissão ML</div>
      <div class="metric-value" style="font-size:16px;">R$ {{ '%.2f'|format(totais.comissao) }}</div>
    </div>
    <div class="col-6 col-md-2">
      <div class="metric-sub">Impostos</div>
      <div class="metric-value" style="font-size:16px;">R$ {{ '%.2f'|format(totais.imposto) }}</div>
    </div>
    <div class="col-6 col-md-2">
      <div class="metric-sub">Despesas</div>
      <div class="metric-value" style="font-size:16px;">R$ {{ '%.2f'|format(totais.despesas) }}</div>
    </div>
  </div>
  <div class="mt-2">
    <div class="metric-sub">Lucro líquido total</div>
    <div class="metric-value" style="font-size:18px;">R$ {{ '%.2f'|format(totais.margem_liquida) }}</div>
  </div>
</div>

<div class="card-soft">
  <div class="table-responsive">
    <table class="table table-sm table-dark-modern align-middle mb-0">
      <thead>
        <tr>
          <th>Produto</th>
          <th class="text-end">Qtd</th>
          <th class="text-end">Receita</th>
          <th class="text-end">Custo</th>
          <th class="text-end">Comissão ML</th>
          <th class="text-end">Imposto</th>
          <th class="text-end">Despesas</th>
          <th class="text-end">Lucro líquido</th>
          <th class="text-end">% sobre receita</th>
        </tr>
      </thead>
      <tbody>
        {% for l in linhas %}
          {% set perc = (l.margem_liquida / l.receita * 100) if l.receita > 0 else 0 %}
          <tr>
            <td>{{ l.produto }}</td>
            <td class="text-end">{{ '%.0f'|format(l.qtd) }}</td>
            <td class="text-end">R$ {{ '%.2f'|format(l.receita) }}</td>
            <td class="text-end">R$ {{ '%.2f'|format(l.custo) }}</td>
            <td class="text-end">R$ {{ '%.2f'|format(l.comissao) }}</td>
            <td class="text-end">R$ {{ '%.2f'|format(l.imposto) }}</td>
            <td class="text-end">R$ {{ '%.2f'|format(l.despesas) }}</td>
            <td class="text-end">R$ {{ '%.2f'|format(l.margem_liquida) }}</td>
            <td class="text-end">
              {{ '%.2f'|format(perc) }}%
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="9" class="text-center text-muted py-3">Nenhuma venda encontrada.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
